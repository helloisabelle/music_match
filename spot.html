<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Music Match</title>
</head>

<body>

            <button id="build_link">Login to Spotify</button>
            <button id="fetch_profile_info">Fetch profile information</button>
            <hr>
            <button id="fetch_top_info">Fetch top artists information</button>
            <hr>
            <button id="fetch_rec_info">Fetch Rec information</button>
            <hr>
            <div id="profile_info">
            </div>
            <div id="top">
            </div>
            <div id="rec">
            </div>

            <div id="error">
            </div>

        	<button onclick = "f()">Final submit</button>

        	<div id="searchA"></div>
            <div id="search"></div>

            <form id = "songs" action="">
				  <input id = "name" type="text">

				  <button onclick = "search()">Click</button>

			</form>
			<div id="not-found">
            </div>
			 <ul id = "song-list"></ul>


			<form id = "artists" action="">
				  <input id = "artist" type="text">
				  <button onclick = "searchA()">Click</button>

			</form>
			<div id="not-found2">
            </div>
			<ul id = "artist-list"></ul>
			<hr>

            <div id="too-many">
            </div>

            <form id = "genres" onchange="check()" action="">
			</form>

			<hr>

</body>


<script>

	function f(){
		if ($("#artist-list li").length + $("#song-list li").length + $("#genres input:checkbox:checked").length == 0){
			$('#error').text("At least one artist, one song or genre needs to be selected.");
		} 

		let g = "";

		var x = 0;

		$("#genres input:checkbox:checked").each(function(){
		    if (x == 0) {
		    	g += $(this).val();
		    }
		    else {
		    	g += ", " + $(this).val();
		    }
		    x++;
		});

		console.log(g);

	}

    const API_ENDPOINT = 'https://api.spotify.com/v1';
    let ACCESS_TOKEN;

    function getCurrentQueryParameters(delimiter = '#') {
        const currentLocation = String(window.location).split(delimiter)[1];
        const params = new URLSearchParams(currentLocation);
        return params;
    }

    function buildAuthLink() {
   		const auth = "https://accounts.spotify.com/authorize?client_id=b17468a2df6a462285038526460b24eb&response_type=token&redirect_uri=http%3A%2F%2Flocalhost%3A8888%2Fspot%2Fspot.html&scope=user-top-read";

        window.location = auth;
    }

    function updateProfileInformation(json) {
        const infoString = `username: ${json.id} has ${json.followers.total} follower(s) on Spotify`;
        const profileInfoElement = document.querySelector('#profile_info');
        profileInfoElement.textContent = infoString;
    }

    function fetchProfileInformation() {

        const currentQueryParameters = getCurrentQueryParameters('#');
        ACCESS_TOKEN = currentQueryParameters.get('access_token');
        const fetchOptions = {
            method: 'GET',
            headers: new Headers({
                'Authorization': `Bearer ${ACCESS_TOKEN}`
            })
        };

        let x = API_ENDPOINT + "/me";

        fetch(x, fetchOptions).then(function (response) {
            return response.json();
        }).then(function (json) {
            updateProfileInformation(json);
        }).catch(function (error) {
            console.log(error);
        });
    }

    function updateTopInformation(json) {
    	var ol = document.createElement("ol");
    	for (var i = 0; i < 10; i++){
    		var li = document.createElement("li");
    		li.innerHTML = json.items[i].name;
    		ol.appendChild(li);
    	}

    	document.querySelector('#top').appendChild(ol);
    }

    function updateRecInformation(json) {
    	var ol = document.createElement("ol");
    	for (var i = 0; i < json.tracks.length; i++){
    		var li = document.createElement("li");
    		li.innerHTML = json.tracks[i].name;
    		ol.appendChild(li);
    	}

    	document.querySelector('#rec').appendChild(ol);
    }

    function fetchRecInformation() {
        const currentQueryParameters = getCurrentQueryParameters('#');
        ACCESS_TOKEN = currentQueryParameters.get('access_token');


    	$.ajax({
            url: 'https://api.spotify.com/v1/recommendations',
            dataType: 'json',
            headers: {
               'Authorization': 'Bearer ' + ACCESS_TOKEN
            },
            data: {
	            limit: 10,
	            seed_genres: 'classical',
	            seed_artists: '4NHQUGzhtTLFvgF5SZesLK'
        	},
        	success: function (response) {
	            console.log(response);
	            response = JSON.parse(JSON.stringify(response));
            	updateRecInformation(response);

	        },
	        error: function(e) {
			    console.log(e);
			  }
        });
    }

    
    function fetchTopInformation() {
        const currentQueryParameters = getCurrentQueryParameters('#');
        ACCESS_TOKEN = currentQueryParameters.get('access_token');

        const fetchTopOptions = {
            method: 'GET',
            headers: new Headers({
                'Authorization': `Bearer ${ACCESS_TOKEN}`,
                'Content-Type': 'application/json',
                
                
                'Accept': 'application/json'
            })
            ,
            data: {
            	time_range: 'medium_term',
            	limit: 10
            }
        };

        let x = API_ENDPOINT + "/me/top/artists";

        fetch(x, fetchTopOptions).then(function (response) {
            return response.json();
        }).then(function (json) {
            updateTopInformation(json);
        }).catch(function (error) {
            console.log(error);
        });
    }

    function searchResultsA(json){ 
    	if ($("#artist-list li").length + $("#song-list li").length + $("#genres input:checkbox:checked").length > 5){
		   $('#too-many').text("Too many filters added.");
		}
		else{
			$('#too-many').text("");
	    	if (json.artists.items.length == 0){
	    		$('#not-found2').show();
	    		$('#not-found2').text("No matching artists with this name were found :(");
	    	}
	    	else {
	    		$('#not-found2').hide();
	    		if ($('#searchA').html() != ""){
	    			$('#searchA').append(", " + json.artists.items[0].id);
	    		}
	    		else {
	    			$('#searchA').append(json.artists.items[0].id);
	    		}

	    		var l = $("<li>");
	    		l.text(json.artists.items[0].name);

	    		$('#artist-list').append(l);
	    	}
    	}
    }


    function searchA(){

    	const currentQueryParameters = getCurrentQueryParameters('#');
        ACCESS_TOKEN = currentQueryParameters.get('access_token');
        var name = $("#artist").val();
        console.log(name);

    	$.ajax({
            url: 'https://api.spotify.com/v1/search',
            dataType: 'json',
            headers: {
               'Authorization': 'Bearer ' + ACCESS_TOKEN
            },
            data: {
	            q: name,
            	type: 'artist',
            	limit: 1
        	},
        	success: function (response) {
	            console.log(response);
	            response = JSON.parse(JSON.stringify(response));
            	searchResultsA(response);

	        },
	        error: function(e) {
			    console.log(e);
			  }
        });
    }


    function searchResults(json){

    	if ($("#artist-list li").length + $("#song-list li").length + $("#genres input:checkbox:checked").length > 5){
		   $('#too-many').text("Too many filters added.");
		}
		else{
			$('#too-many').text("");
	    	if (json.tracks.items.length == 0){
	    		$('#not-found').show();
	    		$('#not-found').text("No matching tracks with this name were found :(");
	    	}
	    	else {
	    		$('#not-found').hide();
	    		if ($('#search').html() != ""){
	    			$('#search').append(", " + json.tracks.items[0].id);
	    		}
	    		else {
	    			$('#search').append(json.tracks.items[0].id);
	    		}

	    		var l = $("<li>");
	    		l.text(json.tracks.items[0].name + " by " + json.tracks.items[0].artists[0].name);

	    		$('#song-list').append(l);
	    	}
    	}
    }

    function search(){
    	const currentQueryParameters = getCurrentQueryParameters('#');
        ACCESS_TOKEN = currentQueryParameters.get('access_token');
        var song = $("#name").val();

    	$.ajax({
            url: 'https://api.spotify.com/v1/search',
            dataType: 'json',
            headers: {
               'Authorization': 'Bearer ' + ACCESS_TOKEN
            },
            data: {
	            q: song,
            	type: 'track',
            	limit: 1
        	},
        	success: function (response) {
	            console.log(response);
	            response = JSON.parse(JSON.stringify(response));
            	searchResults(response);

	        },
	        error: function(e) {
			    console.log(e);
			 }
        });
    }

    function check(){
    	if ($("#artist-list li").length + $("#song-list li").length + $("#genres input:checkbox:checked").length > 5){
		   $('#too-many').text("Too many filters added.");
		}
		else {
			$('#too-many').text("");
		}
    }

    function updateGenres(json){
    	for (var i = 0; i < json.genres.length; i++){
    		var c = $("<input>");
    		c.attr({
    			"type": "checkbox",
    			"id": i,
    			"name": json.genres[i],
    			"value": json.genres[i]
    		});

    		var l = $("<label>");
    		l.attr({
    			"for": json.genres[i],
    		});
    		l.text(json.genres[i]);

    		$('#genres').append(c);
    		$('#genres').append(l);
    		$('#genres').append('<br>');
    	}
    }

    fetchGenres();

    function fetchGenres() {
        const currentQueryParameters = getCurrentQueryParameters('#');
        ACCESS_TOKEN = currentQueryParameters.get('access_token');

        const fetchTopOptions = {
            method: 'GET',
            headers: new Headers({
                'Authorization': `Bearer ${ACCESS_TOKEN}`
            }),
            data: {
            	time_range: 'medium_term',
            	limit: 10
            }
        };

        let x = API_ENDPOINT + "/recommendations/available-genre-seeds";

        fetch(x, fetchTopOptions).then(function (response) {
            return response.json();
        }).then(function (json) {
            updateGenres(json);
        }).catch(function (error) {
            console.log(error);
        });
    }

    const buildButton = document.querySelector('button#build_link');
    buildButton.addEventListener('click', buildAuthLink);

    const fetchButton = document.querySelector('button#fetch_profile_info');
    fetchButton.addEventListener('click', fetchProfileInformation);

    const fetchTopButton = document.querySelector('button#fetch_top_info');
    fetchTopButton.addEventListener('click', fetchTopInformation);

    const fetchRecButton = document.querySelector('button#fetch_rec_info');
    fetchRecButton.addEventListener('click', fetchRecInformation);

</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

</html>

